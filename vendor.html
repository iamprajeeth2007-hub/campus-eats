<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Eats - Vendor Dashboard</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: 24px;
            padding: 48px 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 100%;
        }

        .logo-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 40px;
        }

        .login-card h1 {
            font-size: 28px;
            color: #1a1a1a;
            margin-bottom: 8px;
            text-align: center;
        }

        .login-card p {
            color: #666;
            margin-bottom: 32px;
            font-size: 15px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group select {
            cursor: pointer;
        }

        .info-box {
            background: #f0f9ff;
            border: 2px solid #bfdbfe;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #1e40af;
        }

        .info-box strong {
            display: block;
            margin-bottom: 4px;
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 8px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            background: #fee;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            border: 1px solid #fecaca;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .toggle-form {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-size: 14px;
        }

        .toggle-form a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .toggle-form a:hover {
            text-decoration: underline;
        }

        /* Dashboard */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .header {
            background: white;
            padding: 20px 32px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-logo {
            font-size: 32px;
        }

        .header-title h1 {
            font-size: 24px;
            color: #1a1a1a;
        }

        .header-title p {
            font-size: 14px;
            color: #666;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .logout-btn {
            padding: 8px 16px;
            background: #fee;
            color: #dc2626;
            border: 2px solid #fecaca;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }

        .content {
            padding: 32px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #1a1a1a;
        }

        .stat-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .orders-section {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .section-header {
            padding: 24px;
            border-bottom: 2px solid #f5f5f5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            font-size: 20px;
            color: #1a1a1a;
        }

        .filter-tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-tab {
            padding: 8px 16px;
            background: #f5f5f5;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .filter-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .orders-list {
            padding: 24px;
        }

        .order-card {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }

        .order-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .order-id {
            font-weight: 700;
            font-size: 18px;
            color: #1a1a1a;
        }

        .order-time {
            font-size: 13px;
            color: #666;
        }

        .student-info {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .student-srn {
            font-weight: 600;
            color: #667eea;
        }

        .order-items {
            margin-bottom: 16px;
        }

        .order-item {
            padding: 8px 0;
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }

        .item-name {
            color: #1a1a1a;
        }

        .item-qty {
            color: #666;
        }

        .order-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 16px;
            border-top: 2px solid #e5e7eb;
        }

        .order-total {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
        }

        .order-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-accept {
            background: #10b981;
            color: white;
        }

        .btn-accept:hover {
            background: #059669;
        }

        .btn-ready {
            background: #3b82f6;
            color: white;
        }

        .btn-ready:hover {
            background: #2563eb;
        }

        .btn-complete {
            background: #6b7280;
            color: white;
        }

        .btn-complete:hover {
            background: #4b5563;
        }

        .btn-reject {
            background: #ef4444;
            color: white;
        }

        .btn-reject:hover {
            background: #dc2626;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-preparing {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-ready {
            background: #d1fae5;
            color: #065f46;
        }

        .status-completed {
            background: #e5e7eb;
            color: #374151;
        }

        .empty-state {
            text-align: center;
            padding: 64px 24px;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .empty-text {
            color: #666;
            font-size: 16px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(400px);
            transition: transform 0.4s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid #10b981;
        }

        .notification.error {
            border-left: 4px solid #ef4444;
        }

        @media (max-width: 768px) {
            .header {
                padding: 16px;
            }

            .content {
                padding: 16px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .filter-tabs {
                flex-wrap: wrap;
            }

            .order-actions {
                flex-direction: column;
                width: 100%;
            }

            .action-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Notification -->
    <div id="notification" class="notification">
        <div class="notification-icon">‚ÑπÔ∏è</div>
        <div class="notification-content">
            <div class="notification-title">Notification</div>
            <div class="notification-message">Message</div>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="login-container">
        <div class="login-card">
            <div class="logo-icon">üë®‚Äçüç≥</div>
            <h1>Vendor Dashboard</h1>
            <p id="form-subtitle">Sign in to your account</p>
            
            <div class="error-message" id="error-message"></div>

            <!-- Login Form -->
            <form id="login-form">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" required placeholder="vendor@example.com" autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required placeholder="Enter your password" autocomplete="current-password">
                </div>
                <button type="submit" class="login-btn" id="login-btn">Sign In</button>
            </form>

            <!-- Register Form (Hidden by default) -->
            <form id="register-form" style="display: none;">
                <div class="info-box">
                    <strong>‚ö†Ô∏è Vendor Registration</strong>
                    Only authorized campus food stores can register. Select your store from the list below.
                </div>
                
                <div class="form-group">
                    <label for="store-select">Select Your Store *</label>
                    <select id="store-select" required>
                        <option value="">-- Select your store --</option>
                        <option value="GRUB FOODS">GRUB FOODS</option>
                        <option value="ROLL ME">ROLL ME</option>
                        <option value="SIDDI VINAYAKA GARDEN">SIDDI VINAYAKA GARDEN</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="register-email">Email Address *</label>
                    <input type="email" id="register-email" required placeholder="vendor@example.com" autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="register-password">Password *</label>
                    <input type="password" id="register-password" required placeholder="Minimum 6 characters" autocomplete="new-password">
                </div>
                <div class="form-group">
                    <label for="contact-number">Contact Number (Optional)</label>
                    <input type="tel" id="contact-number" placeholder="9876543210" autocomplete="tel">
                </div>
                <button type="submit" class="login-btn" id="register-btn">Create Account</button>
            </form>

            <div class="toggle-form">
                <span id="toggle-text">Don't have an account? </span>
                <a href="#" id="toggle-link" onclick="toggleForm(event)">Sign Up</a>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="header-logo">üë®‚Äçüç≥</div>
                <div class="header-title">
                    <h1 id="store-name-header">Campus Eats Vendor</h1>
                    <p>Order Management Dashboard</p>
                </div>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">V</div>
                <span id="user-name">Vendor</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">‚è≥</div>
                    <div class="stat-label">Pending Orders</div>
                    <div class="stat-value" id="pending-count">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üë®‚Äçüç≥</div>
                    <div class="stat-label">Preparing</div>
                    <div class="stat-value" id="preparing-count">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-label">Ready</div>
                    <div class="stat-value" id="ready-count">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-label">Today's Revenue</div>
                    <div class="stat-value" id="revenue">‚Çπ0</div>
                </div>
            </div>

            <!-- Orders Section -->
            <div class="orders-section">
                <div class="section-header">
                    <h2>Orders</h2>
                    <div class="filter-tabs">
                        <div class="filter-tab active" onclick="filterOrders('all', event)">All</div>
                        <div class="filter-tab" onclick="filterOrders('pending', event)">Pending</div>
                        <div class="filter-tab" onclick="filterOrders('preparing', event)">Preparing</div>
                        <div class="filter-tab" onclick="filterOrders('ready', event)">Ready</div>
                    </div>
                </div>
                <div class="orders-list" id="orders-list">
                    <!-- Orders loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBlJSNdxM2xzaHMdbPiFqhHKfhkt5Jgqv0",
  authDomain: "campus-eats-007.firebaseapp.com",
  projectId: "campus-eats-007",
  storageBucket: "campus-eats-007.firebasestorage.app",
  messagingSenderId: "201751423832",
  appId: "1:201751423832:web:6d4592dbc1053789fb132d"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentFilter = 'all';
        let ordersListener = null;
        let isLoginForm = true;
        let currentVendorStore = null;

        const VALID_STORES = ['GRUB FOODS', 'ROLL ME', 'SIDDI VINAYAKA GARDEN'];

        // Toggle between login and register forms
        function toggleForm(e) {
            e.preventDefault();
            isLoginForm = !isLoginForm;
            
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const subtitle = document.getElementById('form-subtitle');
            const toggleText = document.getElementById('toggle-text');
            const toggleLink = document.getElementById('toggle-link');
            
            if (isLoginForm) {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                subtitle.textContent = 'Sign in to your account';
                toggleText.textContent = "Don't have an account? ";
                toggleLink.textContent = 'Sign Up';
            } else {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                subtitle.textContent = 'Create a new vendor account';
                toggleText.textContent = 'Already have an account? ';
                toggleLink.textContent = 'Sign In';
            }
            
            hideError();
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }

        // Hide error message
        function hideError() {
            const errorDiv = document.getElementById('error-message');
            errorDiv.classList.remove('show');
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const icon = notification.querySelector('.notification-icon');
            const title = notification.querySelector('.notification-title');
            const messageEl = notification.querySelector('.notification-message');

            if (type === 'success') {
                icon.textContent = '‚úÖ';
                notification.className = 'notification success';
                title.textContent = 'Success';
            } else {
                icon.textContent = '‚ùå';
                notification.className = 'notification error';
                title.textContent = 'Error';
            }

            messageEl.textContent = message;
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => notification.classList.remove('show'), 4000);
        }

        // Login Form Submit
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideError();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('login-btn');
            
            btn.disabled = true;
            btn.textContent = 'Signing in...';
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Check if vendor exists in vendors collection
                const vendorDoc = await db.collection('vendors').doc(user.uid).get();
                
                if (!vendorDoc.exists) {
                    throw new Error('Vendor account not found. Please contact admin.');
                }
                
                const vendorData = vendorDoc.data();
                
                if (!VALID_STORES.includes(vendorData.storeName)) {
                    throw new Error('Invalid store. Please contact admin.');
                }
                
                currentVendorStore = vendorData.storeName;
                
                showNotification(`Welcome back to ${currentVendorStore}!`);
                showDashboard(user, vendorData);
                
            } catch (error) {
                console.error('Login error:', error);
                let errorMessage = 'Login failed. Please try again.';
                
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'No account found with this email.';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Incorrect password.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many failed attempts. Please try again later.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showError(errorMessage);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Sign In';
            }
        });

        // Register Form Submit
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideError();
            
            const storeName = document.getElementById('store-select').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const contactNumber = document.getElementById('contact-number').value;
            const btn = document.getElementById('register-btn');
            
            // Validation
            if (!storeName) {
                showError('Please select your store.');
                return;
            }
            
            if (!VALID_STORES.includes(storeName)) {
                showError('Invalid store selection. Please choose from the list.');
                return;
            }
            
            if (password.length < 6) {
                showError('Password must be at least 6 characters long.');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Creating account...';
            
            try {
                // Check if this store already has a vendor registered
                const existingVendor = await db.collection('vendors')
                    .where('storeName', '==', storeName)
                    .get();
                
                if (!existingVendor.empty) {
                    throw new Error(`A vendor account for "${storeName}" already exists. Each store can only have one account. Please contact admin if you need access.`);
                }
                
                // Create Firebase Auth user
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Store vendor info in Firestore
                await db.collection('vendors').doc(user.uid).set({
                    email: user.email,
                    storeName: storeName,
                    contactNumber: contactNumber || '',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    isActive: true
                });

                currentVendorStore = storeName;
                showNotification(`Account created for ${storeName}!`);
                showDashboard(user, { storeName });
                
            } catch (error) {
                console.error('Registration error:', error);
                let errorMessage = 'Registration failed. Please try again.';
                
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'An account with this email already exists. Please sign in instead.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password is too weak.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showError(errorMessage);
                
                // If error occurred after user creation, delete the user
                if (auth.currentUser) {
                    await auth.currentUser.delete().catch(console.error);
                }
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Account';
            }
        });

        // Logout
        async function logout() {
            try {
                if (ordersListener) {
                    ordersListener();
                }
                await auth.signOut();
                currentVendorStore = null;
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('dashboard').classList.remove('active');
                showNotification('Logged out successfully');
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Show Dashboard
        async function showDashboard(user, vendorData) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            
            const storeName = vendorData.storeName || 'Your Store';
            currentVendorStore = storeName;
            
            // Update header with store name
            document.getElementById('store-name-header').textContent = storeName;
            document.getElementById('user-name').textContent = storeName;
            document.getElementById('user-avatar').textContent = storeName.charAt(0).toUpperCase();
            
            // Update last login
            try {
                await db.collection('vendors').doc(user.uid).update({
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error('Error updating last login:', error);
            }
            
            // Load orders for this store only
            loadOrders();
        }

        // Load Orders with Real-time Updates (FILTERED BY STORE)
        function loadOrders() {
            if (ordersListener) {
                ordersListener();
            }

            if (!currentVendorStore) {
                console.error('No store selected');
                return;
            }

            // CRITICAL: Filter orders by storeName
            ordersListener = db.collection('orders')
                .where('storeName', '==', currentVendorStore)
                .orderBy('createdAt', 'desc')
                .onSnapshot((snapshot) => {
                    const orders = [];
                    snapshot.forEach(doc => {
                        orders.push({ id: doc.id, ...doc.data() });
                    });
                    
                    console.log(`Loaded ${orders.length} orders for ${currentVendorStore}`);
                    updateStats(orders);
                    renderOrders(orders);
                }, (error) => {
                    console.error('Error loading orders:', error);
                    
                    // If the error is because storeName field doesn't exist in orders
                    if (error.code === 'failed-precondition') {
                        showNotification('Creating database index. Please wait 2 minutes and refresh the page.', 'error');
                        
                        // Try to load without the index for now
                        loadOrdersWithoutIndex();
                    } else {
                        showNotification('Failed to load orders: ' + error.message, 'error');
                    }
                });
        }

        // Fallback: Load orders without index (temporary solution)
        function loadOrdersWithoutIndex() {
            console.log('Loading orders without index...');
            
            db.collection('orders')
                .orderBy('createdAt', 'desc')
                .onSnapshot((snapshot) => {
                    const allOrders = [];
                    snapshot.forEach(doc => {
                        const orderData = doc.data();
                        // Client-side filtering
                        if (orderData.storeName === currentVendorStore) {
                            allOrders.push({ id: doc.id, ...orderData });
                        }
                    });
                    
                    console.log(`Loaded ${allOrders.length} orders (client-filtered) for ${currentVendorStore}`);
                    updateStats(allOrders);
                    renderOrders(allOrders);
                });
        }

        // Update Stats
        function updateStats(orders) {
            const pending = orders.filter(o => o.status === 'pending').length;
            const preparing = orders.filter(o => o.status === 'preparing').length;
            const ready = orders.filter(o => o.status === 'ready').length;
            
            // Calculate today's revenue
            const today = new Date().setHours(0, 0, 0, 0);
            const revenue = orders
                .filter(o => {
                    if (!o.createdAt) return false;
                    const orderDate = o.createdAt.toDate().setHours(0, 0, 0, 0);
                    return orderDate === today;
                })
                .reduce((sum, o) => sum + (o.total || 0), 0);

            document.getElementById('pending-count').textContent = pending;
            document.getElementById('preparing-count').textContent = preparing;
            document.getElementById('ready-count').textContent = ready;
            document.getElementById('revenue').textContent = `‚Çπ${revenue}`;
        }

        // Filter Orders
        function filterOrders(status, event) {
            currentFilter = status;
            
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Re-render with current orders
            loadOrders();
        }

        // Render Orders
        function renderOrders(orders) {
            const container = document.getElementById('orders-list');
            
            // Apply filter
            let filtered = orders;
            if (currentFilter !== 'all') {
                filtered = orders.filter(o => o.status === currentFilter);
            }

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì¶</div>
                        <div class="empty-text">No ${currentFilter === 'all' ? '' : currentFilter} orders found</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(order => {
                const timeStr = order.createdAt ? formatTime(order.createdAt.toDate()) : 'Just now';
                
                return `
                    <div class="order-card">
                        <div class="order-header">
                            <div>
                                <div class="order-id">Order #${order.id.slice(-6)}</div>
                                <div class="order-time">${timeStr}</div>
                            </div>
                            <span class="status-badge status-${order.status}">
                                ${order.status}
                            </span>
                        </div>
                        
                        <div class="student-info">
                            Student SRN: <span class="student-srn">${order.srn || 'N/A'}</span>
                        </div>
                        
                        <div class="order-items">
                            ${(order.items || []).map(item => `
                                <div class="order-item">
                                    <span class="item-name">${item.name}</span>
                                    <span class="item-qty">x${item.quantity} - ‚Çπ${item.price * item.quantity}</span>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="order-footer">
                            <div class="order-total">Total: ‚Çπ${order.total || 0}</div>
                            <div class="order-actions">
                                ${getActionButtons(order.id, order.status)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Get Action Buttons based on status
        function getActionButtons(orderId, status) {
            if (status === 'pending') {
                return `
                    <button class="action-btn btn-accept" onclick="updateOrderStatus('${orderId}', 'preparing')">
                        Accept Order
                    </button>
                    <button class="action-btn btn-reject" onclick="updateOrderStatus('${orderId}', 'rejected')">
                        Reject
                    </button>
                `;
            } else if (status === 'preparing') {
                return `
                    <button class="action-btn btn-ready" onclick="updateOrderStatus('${orderId}', 'ready')">
                        Mark as Ready
                    </button>
                `;
            } else if (status === 'ready') {
                return `
                    <button class="action-btn btn-complete" onclick="updateOrderStatus('${orderId}', 'completed')">
                        Complete Order
                    </button>
                `;
            }
            return '';
        }

        // Update Order Status
        async function updateOrderStatus(orderId, newStatus) {
            try {
                await db.collection('orders').doc(orderId).update({
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                const statusMessages = {
                    'preparing': 'Order accepted!',
                    'ready': 'Order marked as ready!',
                    'completed': 'Order completed!',
                    'rejected': 'Order rejected'
                };

                showNotification(statusMessages[newStatus] || 'Status updated');
                
            } catch (error) {
                console.error('Error updating order:', error);
                showNotification('Failed to update order', 'error');
            }
        }

        // Format Time
        function formatTime(date) {
            const now = new Date();
            const diff = Math.floor((now - date) / 1000); // seconds

            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)} min ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)} hours ago`;
            return date.toLocaleDateString();
        }

        // Check Auth State
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    const vendorDoc = await db.collection('vendors').doc(user.uid).get();
                    if (vendorDoc.exists) {
                        const vendorData = vendorDoc.data();
                        if (VALID_STORES.includes(vendorData.storeName)) {
                            showDashboard(user, vendorData);
                        } else {
                            await auth.signOut();
                            showError('Invalid store. Please contact admin.');
                        }
                    } else {
                        // User exists in auth but not in vendors collection
                        await auth.signOut();
                        showError('Vendor account not found. Please contact admin.');
                    }
                } catch (error) {
                    console.error('Error loading vendor data:', error);
                    await auth.signOut();
                }
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('dashboard').classList.remove('active');
            }
        });

        // Play notification sound when new order arrives for THIS STORE
        let lastOrderCount = 0;
        auth.onAuthStateChanged((user) => {
            if (user && currentVendorStore) {
                db.collection('orders')
                    .where('storeName', '==', currentVendorStore)
                    .where('status', '==', 'pending')
                    .onSnapshot(snapshot => {
                        const currentCount = snapshot.size;
                        if (currentCount > lastOrderCount && lastOrderCount > 0) {
                            showNotification('üîî New order received!');
                        }
                        lastOrderCount = currentCount;
                    }, (error) => {
                        // Silent fail for notification listener
                        console.log('Notification listener error (expected during setup):', error.code);
                    });
            }
        });
    </script>
</body>
</html>
